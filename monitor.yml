---
- hosts: monitor
  become: yes
  remote_user: adminfpi
  tasks:

# INSTALL JAVA #########################

    - name: Install add-apt-repostory
      become: yes
      apt: name=software-properties-common

    - name: Add Oracle Java Repository
      become: yes
      apt_repository: repo='ppa:webupd8team/java'
      update_cache=yes

    - name: Accept Java 8 License
      become: yes
      debconf: name='oracle-java8-installer' question='shared/accepted-oracle-license-v1-1' value='true' vtype='select'

    - name: Install Oracle Java 8
      become: yes
      apt: name={{ item }}
      with_items:
        - oracle-java8-installer
        - ca-certificates
        - oracle-java8-set-default

# INSTALL ElasticSearch #####################################

    - name: Add ElasticSearch Source
      lineinfile:
        path: /etc/apt/sources.list
        line: deb https://artifacts.elastic.co/packages/7.x/apt stable main
        create: yes

    - name: Install ElasticSearch Keys
      apt_key:
        url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
        state: present

    - name: Install ElasticSearch
      apt:
        name:
          - elasticsearch
        state: present

    - name: Add ElasticSearch IP
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        line: "network.host: 192.168.10.108"
        create: yes

    - name: Add ElasticSearch Port
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        line: "http.port: 9200"
        create: yes

    - name: ensure ElasticSearch is running
      service:
        name: elasticsearch
        state: started
        enabled: true

# INSTALL KIBANA #############################################

    - name: Install Kibana
      apt:
        name:
          - kibana
        state: present

# ElasticSearch FIREWALL ######################################

    - name: Enable UFW And Deny All
      ufw:
        state: enabled
        policy: deny

    - name: Set Logging
      ufw:
        logging: 'on'

    - name: Allow SSH
      ufw:
        rule: allow
        name: OpenSSH
        src: 192.168.10.0/24

    - name: Allow ElasticSearch tcp port 9200
      ufw:
        rule: allow
        port: '9200'
        proto: tcp
        src: 192.168.10.0/24